from fastapi import FastAPI, File, UploadFile
from fastapi.responses import JSONResponse
from ultralytics import YOLO
from io import BytesIO
from PIL import Image

app = FastAPI()

# Load YOLO model once
model = YOLO("yolov8n.pt")

@app.get("/")
def root():
    return {"status": "ok"}

@app.post("/detect")
async def detect(file: UploadFile = File(...)):
    try:
        contents = await file.read()
        image = Image.open(BytesIO(contents)).convert("RGB")

        results = model(image)

        detections = []
        for r in results:
            boxes = r.boxes
            names = r.names
            for box in boxes:
                cls_id = int(box.cls[0].item())
                label = names[cls_id]
                conf = float(box.conf[0].item())
                detections.append({
                    "label": label,
                    "confidence": conf
                })

        detections.sort(key=lambda d: d["confidence"], reverse=True)
        best_label = detections[0]["label"] if detections else ""

        return JSONResponse({
            "best_label": best_label,
            "detections": detections
        })

    except Exception as e:
        return JSONResponse({"error": str(e)}, status_code=500)
